<?php
mysql_connect("127.0.0.1","root","");
mysql_select_db("sapui5"); 

$sth = mysql_query("select * from vbak");
$num_rows = mysql_num_rows($sth);
$results = array();
$n = 0;
$m = 0;
while($row = mysql_fetch_array($sth)) {
  $sth2 = mysql_query("select * from vbap where Vbeln = '".$row['Vbeln']."'");
$bil_rows = mysql_num_rows($sth2);  
$m++;
    while($row2 = mysql_fetch_array($sth2)) {	
  $n++;	
	if ( $n == 1 ) {
$json1 = '{"SD": [{';	
$json1.='"Vbeln": ';	
$json1.='"'.$row['Vbeln'].'"';
$json1.=',';
$json1.='"Audat": ';	
$json1.='"'.$row['Audat'].'"';
$json1.=',';
$json1.='"Netwr": ';
$json1.='"'.$row['Netwr'].'"';
$json1.=',';
$json1.='"Waerk": ';
$json1.='"'.$row['Waerk'].'"';
$json1.=',';
$json1.='"Vkorg": ';
$json1.='"'.$row['Vkorg'].'"';
$json1.=',';
$json1.='"Vtweg": ';
$json1.='"'.$row['Vtweg'].'"';
$json1.=',';
$json1.='"Spart": ';
$json1.='"'.$row['Spart'].'"';
$json1.=',';
$json1.='"Vkgrp": ';
$json1.='"'.$row['Vkgrp'].'"';
$json1.=',';
$json1.='"ApprovalStatus": ';
$json1.='"'.$row['ApprovalStatus'].'"';
$json1.=',';
$json1.='"LineHeader": {';
$json1.='"Vbeln": ';
$json1.='"'.$row['Vbeln'].'"';
$json1.=',';
$json1.='"Audat": ';
$json1.='"'.$row['Audat'].'"';
$json1.=',';
$json1.='"Netwr": ';
$json1.='"'.$row['Netwr'].'"';
$json1.=',';
$json1.='"Waerk": ';
$json1.='"'.$row['Waerk'].'"';
$json1.=',';
$json1.='"Vkorg": ';
$json1.='"'.$row['Vkorg'].'"';
$json1.=',';
$json1.='"Vtweg": ';
$json1.='"'.$row['Vtweg'].'"';
$json1.=',';
$json1.='"Spart": ';
$json1.='"'.$row['Spart'].'"';
$json1.=',';
$json1.='"Vkgrp": ';
$json1.='"'.$row['Vkgrp'].'"';
$json1.=',';
$json1.='"ApprovalStatus": ';
$json1.='"'.$row['ApprovalStatus'].'"';
$json1.='}';
$json1.=',';
$json1.='"LineItems": [{';
$json1.='"Vbeln": ';
$json1.='"'.$row2['Vbeln'].'"';
$json1.=',';
$json1.='"Posnr": ';
$json1.='"'.$row2['Posnr'].'"';    
$json1.=',';
$json1.='"Erdat": ';
$json1.='"'.$row2['Erdat'].'"';    
$json1.=',';
$json1.='"Matnr": ';
$json1.='"'.$row2['Matnr'].'"';  
$json1.=',';
$json1.='"Matkl": ';
$json1.='"'.$row2['Matkl'].'"';  
$json1.=',';
$json1.='"Arktx": ';
$json1.='"'.$row2['Arktx'].'"'; 
$json1.=',';
$json1.='"Spart": ';
$json1.='"'.$row2['Spart'].'"'; 
$json1.=',';
$json1.='"Gsber": ';
$json1.='"'.$row2['Gsber'].'"'; 
$json1.=',';
$json1.='"Netwr": ';
$json1.='"'.$row2['Netwr'].'"'; 
$json1.=',';
$json1.='"Waerk": ';
$json1.='"'.$row2['Waerk'].'"'; 
$json1.=',';
$json1.='"DocStatus": ';
$json1.='"'.$row2['DocStatus'].'"'; 
$json1.=',';
$json1.='"LineItemsDetail": {';
$json1.='"Vbeln": ';
$json1.='"'.$row2['Vbeln'].'"';
$json1.=',';
$json1.='"Posnr": ';
$json1.='"'.$row2['Posnr'].'"';    
$json1.=',';
$json1.='"Erdat": ';
$json1.='"'.$row2['Erdat'].'"';    
$json1.=',';
$json1.='"Matnr": ';
$json1.='"'.$row2['Matnr'].'"';  
$json1.=',';
$json1.='"Matkl": ';
$json1.='"'.$row2['Matkl'].'"';  
$json1.=',';
$json1.='"Arktx": ';
$json1.='"'.$row2['Arktx'].'"'; 
$json1.=',';
$json1.='"Spart": ';
$json1.='"'.$row2['Spart'].'"'; 
$json1.=',';
$json1.='"Gsber": ';
$json1.='"'.$row2['Gsber'].'"'; 
$json1.=',';
$json1.='"Netwr": ';
$json1.='"'.$row2['Netwr'].'"'; 
$json1.=',';
$json1.='"Waerk": ';
$json1.='"'.$row2['Waerk'].'"'; 
$json1.=',';
$json1.='"DocStatus": ';
$json1.='"'.$row2['DocStatus'].'"'; 
$json1.='}},'; 
//        echo "<br/>";  
//        $SbId1 = $row2['SbItemPos'];		
  $Vbeln1 = $row['Vbeln'];
	}  	
 	if ( $n > 1 ) {		
	if ( $row2['Vbeln'] == $Vbeln1 ) {
$json1.='{';	
$json1.='"Vbeln": ';
$json1.='"'.$row2['Vbeln'].'"';
$json1.=',';
$json1.='"Posnr": ';
$json1.='"'.$row2['Posnr'].'"';    
$json1.=',';
$json1.='"Erdat": ';
$json1.='"'.$row2['Erdat'].'"';    
$json1.=',';
$json1.='"Matnr": ';
$json1.='"'.$row2['Matnr'].'"';  
$json1.=',';
$json1.='"Matkl": ';
$json1.='"'.$row2['Matkl'].'"';  
$json1.=',';
$json1.='"Arktx": ';
$json1.='"'.$row2['Arktx'].'"'; 
$json1.=',';
$json1.='"Spart": ';
$json1.='"'.$row2['Spart'].'"'; 
$json1.=',';
$json1.='"Gsber": ';
$json1.='"'.$row2['Gsber'].'"'; 
$json1.=',';
$json1.='"Netwr": ';
$json1.='"'.$row2['Netwr'].'"'; 
$json1.=',';
$json1.='"Waerk": ';
$json1.='"'.$row2['Waerk'].'"'; 
$json1.=',';
$json1.='"DocStatus": ';
$json1.='"'.$row2['DocStatus'].'"'; 
$json1.=',';
$json1.='"LineItemsDetail": {';
$json1.='"Vbeln": ';
$json1.='"'.$row2['Vbeln'].'"';
$json1.=',';
$json1.='"Posnr": ';
$json1.='"'.$row2['Posnr'].'"';    
$json1.=',';
$json1.='"Erdat": ';
$json1.='"'.$row2['Erdat'].'"';    
$json1.=',';
$json1.='"Matnr": ';
$json1.='"'.$row2['Matnr'].'"';  
$json1.=',';
$json1.='"Matkl": ';
$json1.='"'.$row2['Matkl'].'"';  
$json1.=',';
$json1.='"Arktx": ';
$json1.='"'.$row2['Arktx'].'"'; 
$json1.=',';
$json1.='"Spart": ';
$json1.='"'.$row2['Spart'].'"'; 
$json1.=',';
$json1.='"Gsber": ';
$json1.='"'.$row2['Gsber'].'"'; 
$json1.=',';
$json1.='"Netwr": ';
$json1.='"'.$row2['Netwr'].'"'; 
$json1.=',';
$json1.='"Waerk": ';
$json1.='"'.$row2['Waerk'].'"'; 
$json1.=',';
$json1.='"DocStatus": ';
$json1.='"'.$row2['DocStatus'].'"'; 
  $Vbeln1 = $row['Vbeln'];   
if ( $m == $num_rows ) {	
	$json1.='}}]}]}'; 	
	}	
echo $json1;  
        }		  
	elseif ( $row2['Vbeln'] != $Vbeln1 ) { 
    $json1 = "";  
	$json1.='}}]},';	
$json1.='{';
$json1.='"Vbeln": ';	
$json1.='"'.$row['Vbeln'].'"';
$json1.=',';
$json1.='"Audat": ';	
$json1.='"'.$row['Audat'].'"';
$json1.=',';
$json1.='"Netwr": ';
$json1.='"'.$row['Netwr'].'"';
$json1.=',';
$json1.='"Waerk": ';
$json1.='"'.$row['Waerk'].'"';
$json1.=',';
$json1.='"Vkorg": ';
$json1.='"'.$row['Vkorg'].'"';
$json1.=',';
$json1.='"Vtweg": ';
$json1.='"'.$row['Vtweg'].'"';
$json1.=',';
$json1.='"Spart": ';
$json1.='"'.$row['Spart'].'"';
$json1.=',';
$json1.='"Vkgrp": ';
$json1.='"'.$row['Vkgrp'].'"';
$json1.=',';
$json1.='"ApprovalStatus": ';
$json1.='"'.$row['ApprovalStatus'].'"';
$json1.=',';
$json1.='"LineHeader": {';
$json1.='"Vbeln": ';
$json1.='"'.$row['Vbeln'].'"';
$json1.=',';
$json1.='"Audat": ';
$json1.='"'.$row['Audat'].'"';
$json1.=',';
$json1.='"Netwr": ';
$json1.='"'.$row['Netwr'].'"';
$json1.=',';
$json1.='"Waerk": ';
$json1.='"'.$row['Waerk'].'"';
$json1.=',';
$json1.='"Vkorg": ';
$json1.='"'.$row['Vkorg'].'"';
$json1.=',';
$json1.='"Vtweg": ';
$json1.='"'.$row['Vtweg'].'"';
$json1.=',';
$json1.='"Spart": ';
$json1.='"'.$row['Spart'].'"';
$json1.=',';
$json1.='"Vkgrp": ';
$json1.='"'.$row['Vkgrp'].'"';
$json1.=',';
$json1.='"ApprovalStatus": ';
$json1.='"'.$row['ApprovalStatus'].'"';
$json1.='}';
$json1.=',';
$json1.='"LineItems": [{';
$json1.='"Vbeln": ';
$json1.='"'.$row2['Vbeln'].'"';
$json1.=',';
$json1.='"Posnr": ';
$json1.='"'.$row2['Posnr'].'"';    
$json1.=',';
$json1.='"Erdat": ';
$json1.='"'.$row2['Erdat'].'"';    
$json1.=',';
$json1.='"Matnr": ';
$json1.='"'.$row2['Matnr'].'"';  
$json1.=',';
$json1.='"Matkl": ';
$json1.='"'.$row2['Matkl'].'"';  
$json1.=',';
$json1.='"Arktx": ';
$json1.='"'.$row2['Arktx'].'"'; 
$json1.=',';
$json1.='"Spart": ';
$json1.='"'.$row2['Spart'].'"'; 
$json1.=',';
$json1.='"Gsber": ';
$json1.='"'.$row2['Gsber'].'"'; 
$json1.=',';
$json1.='"Netwr": ';
$json1.='"'.$row2['Netwr'].'"'; 
$json1.=',';
$json1.='"Waerk": ';
$json1.='"'.$row2['Waerk'].'"'; 
$json1.=',';
$json1.='"DocStatus": ';
$json1.='"'.$row2['DocStatus'].'"'; 
$json1.=',';
$json1.='"LineItemsDetail": {';
$json1.='"Vbeln": ';
$json1.='"'.$row2['Vbeln'].'"';
$json1.=',';
$json1.='"Posnr": ';
$json1.='"'.$row2['Posnr'].'"';    
$json1.=',';
$json1.='"Erdat": ';
$json1.='"'.$row2['Erdat'].'"';    
$json1.=',';
$json1.='"Matnr": ';
$json1.='"'.$row2['Matnr'].'"';  
$json1.=',';
$json1.='"Matkl": ';
$json1.='"'.$row2['Matkl'].'"';  
$json1.=',';
$json1.='"Arktx": ';
$json1.='"'.$row2['Arktx'].'"'; 
$json1.=',';
$json1.='"Spart": ';
$json1.='"'.$row2['Spart'].'"'; 
$json1.=',';
$json1.='"Gsber": ';
$json1.='"'.$row2['Gsber'].'"'; 
$json1.=',';
$json1.='"Netwr": ';
$json1.='"'.$row2['Netwr'].'"'; 
$json1.=',';
$json1.='"Waerk": ';
$json1.='"'.$row2['Waerk'].'"'; 
$json1.=',';
$json1.='"DocStatus": ';
$json1.='"'.$row2['DocStatus'].'"'; 
$json1.='}},';
  $Vbeln1 = $row['Vbeln'];     
	    }
    }  // if n > 1 
 }	// while dalam
}  // while luar

//echo "<br/>";

//echo $num_rows;
//echo "<br/>";
//echo $m;
//$baris = array('BenefitClaim' => $results);
//print json_encode($baris);
?>